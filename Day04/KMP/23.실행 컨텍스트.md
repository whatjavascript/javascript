# 23장. 실행 컨텍스트

- 실행 컨텍스트는 자바스크립트의 동작 원리를 담고 있는 핵심 개념

### 01. 소스코드의 타입
- ECMAScript 사양은 소스코드를 4가지 타입으로 구분
  - 전역 코드
    - 전역에 존재하는 소스코드. 전역에 정의된 함수, 클래스 등의 내부 코드는 포함되지 않음
    - 전역 변수를 관리하기 위해 최상위 스코프인 전역 스코프를 생성
    - var 키워드로 선언된 전역 변수와 함수 선언문으로 정의된 전역 함수를 전역 객체의 프로퍼티와 메서드로 바인딩하고 참조하기 위해 전역 객체와 연결
    - 전역 코드가 평가되면 전역 실행 컨텍스트가 생성됨
  - 함수 코드
    - 함수 내부에 존재하는 소스코드.  함수 내부에 중첩된 함수, 클래스 등의 내부 코드는 포함되지 않음
    - 지역 스코프를 생성하고 지역 변수, 매개변수, arguments 객체 관리
    - 생성한 지역 스코프를 전역 스코프에서 시작하는 스코프 체인의 일원으로 연결
    - 함수 코드가 평가되면 함수 실행 컨텍스트가 생성
  - eval 코드
    - 빌트인 전역 함수인 eval 함수에 인수로 전달되어 실행되는 소스코드
    - strict mode에서 자신만의 독자적인 스코프를 생성하고 eval 코드가 평가되면 eval 실행 컨텍스트가 생성
  - 모듈 코드
    - 모듈 내부에 존재하는 코드. 모듈 내부의 함수, 클래스 등의 내부 코드는 포함되지 않음
    - 모듈별로 독립적인 모듈 스코프를 생성
    - 모듈 코드가 평가되면 모듈 실행 컨텍스트가 생성

### 02. 소스코드의 평가와 실행
- 모든 소스코드는 실행에 앞서 평가 과정을 거치며 코드를 실행하기 위한 준비를 함
- 자바스크립트 엔진은 소스코드를 2개의 과정으로 나누어 처리
- 소스코드의 평가
  - 실행 컨텍스트를 생성하고 변수, 함수 등의 선언문만 먼저 실행하여 생성된 변수나 함수 식별자를 키로 실행 컨텍스트가 관리하는 스코프(렉시컬 환경의 환경 레코드)에 등록
- 소스코드의 실행
  - 소스코드 평가 과정이 끝나고 선언문을 제외한 소스코드가 순차적으로 실행(런타임)한다.
  -  소스코드 실행에 필요한 정보, 즉 변수나 함수의 참조를 실행 컨텍스트가 관리하는 스코프에서 검색해서 취득한다.
  -   변수 값의 변경 등 소스코드의 실행 결과는 다시 실행 컨텍스트가 관리하는 스코프에 등록한다

### 03. 실행 컨텍스트의 역할

```
// 전역 변수 선언
const x = 1;
const y = 2;

// 함수 정의
function foo(a) {
  // 지역 변수 선언
  const x = 10;
  const y = 20;
  
  // 메서드 호출
  console.log(a + x + y);	// 130
}

// 함수 호출
foo(100);

// 메서드 호출
console.log(x + y);	// 3
```

1. 전역 코드 평가
2. 전역 코드 실행
3. 함수 코드 평가
4. 함수 코드 실행

### 04. 실행 컨텍스트 스택
- 실행 컨텍스트는 스택 자료구조로 관리 (= 실행 컨텍스트 스택)
- 코드가 실행되는 시간의 흐름에 따라 실행 컨텍스트 스택에는 실행 컨텍스트가 추가되고 제거된다.
  
```
const x = 1;

function foo () {
  const y = 2;
  
  function bar () {
    const z = 3;
    console.log(x + y + z);
  }
  bar();
}

foo();	// 6
```

1. 전역 코드의 평가와 실행
2. foo 함수 코드의 평가와 실행
3. bar 함수 코드의 평가와 실행
4. foo 함수 코드로 복귀
5. 전역 코드로 복귀

### 05. 렉시컬 환경
- 식별자와 식별자에 바인딩된 값, 그리고 상위 스코프에 대한 참조를 기록하는 자료구조로 실행 컨텍스트를 구성하는 컴포넌트
- 실행 컨텍스트 스택이 코드의 실행 순서를 관리한다면 렉시컬 환경은 스코프와 식별자를 관리
- 렉시컬 환경은 키와 값을 갖는 객체 형태의 스코프(전역, 함수, 블록 스코프)를 생성하여 식별자를 키로 등록하고 식별자에 바인딩된 값을 관리
- 렉시컬 환경은 스코프를 구분하여 식별자를 등록하고 관리하는 저장소의 역할을 하는 렉시컬 스코프의 실체
- 실행 컨텍스트는 LexicalEnvironment 컴포넌트와 VariableEnvironment 컴포넌트로 구성
  - 생성 초기 실행 컨텍스트의 LexicalEnvironment 컴포넌트와 VariableEnvironment 컴포넌트는 하나의 동일한 렉시컬 환경을 참조
  - 이후 몇 가지 상황을 만나면 VariableEnvironment 컴포넌트를 위한 새로운 렉시컬 환경을 생성
- 렉시컬 환경은 EnvironmentRecord와 OuterLexicalEnvironmentReference 두 개의 컴포넌트로 구성
  - 환경 레코드(EnvironmentRecord)
    - 스코프의 포함된 식별자를 등록하고 등록된 식별자에 바인딩된 값을 관리하는 저장소. 소스코드의 타입에 따라 관리하는 내용에 차이가 있음
  - 외부 렉시컬 환경에 대한 참조(OuterLexicalEnvironmentReference)
    - 외부 렉시컬 환경에 대한 참조는 상위 스코프를 가리킨다. 이때 상위 스코프란 외부 렉시컬 환경, 즉 해당 실행 컨텍트스를 생성한 소스코드를 포함하는 상위 코드의 렉시컬 환경을 말함. 외부 렉시컬 환경에 대한 참조를 통해 단방향 링크드 리스트인 스코프 체인을 구성

### 06. 실행 컨텍스트의 생성과 식별자 검색 과정
- 전역 객체 생성
  - 전역 객체는 전역 코드가 평가되기 이전에 생성
  - 전역 객체에는 빌트인 전역 프로퍼티와 빌트인 전역 함수, 그리고 표준 빌트인 객체가 추가되며 동작 환경에 따라 클라이언트 사이드 Web API 또는 특정 환경을 위한 호스트 객체를 포함
  - 전역 객체도 Object.prototype을 상속받으며, 프로토타입 체인의 일원

- 전역 코드 평가
  - 소스코드가 로드되면 자바스크립트 엔진은 전역 코드를 평가
  - 전역 코드 평가 순서
    1. 전역 실행 컨텍스트 생성
    2. 전역 렉시컬 환경 생성<br/>
     2.1. 전역 환경 레코드 생성<br/>
        2.1.1. 객체 환경 레코드 생성<br/>
        2.1.1. 선언적 환경 레코드 생성<br/>
    2.2 this 바인딩<br/>
    2.3 외부 렉시컬 환경에 대한 참조 결정

- 전역 코드 실행
  - 전역 코드가 순차적으로 실행되기 시작
  - 동일한 이름의 식별자가 다른 스코프에 여러 개 존재할 수도 있는데, 어느 스코프의 식별자를 참조하면 되는지 결정하는 것을 식별자 결정이라 함
  - 식별자 결정을 위해 식별자를 검색할 때는 실행 중인 실행 컨텍스트에서 식별자를 검색하기 시작
  - 실행 컨텍스트는 소스코드를 실행하기 위해 필요한 환경을 제공하고 코드의 실행 결과를 실제로 관리하는 영역

### 07. 실행 컨텍스트와 블록 레벨 스코프
- var 키워드로 선언한 변수는 오로지 함수의 코드 블록만 지역 스코프로 인정하는 함수 레벨 스코프를 따름
- let, const 키워드로 선언한 변수는 모든 코드 블록(함수, if 문, for 문, while 문, try/catch 문 등)을 지역 스코프로 인정하는 블록 레벨 스코프를 따름
